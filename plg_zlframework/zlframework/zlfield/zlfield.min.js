(function(b){var l=function(){};l.prototype=b.extend(l.prototype,{name:"ZLfield",options:{url:"",type:"",enviroment:"",enviroment_args:""},initialize:function(g,f){this.options=b.extend({},this.options,f);var a=this;b("#toolbar-apply, #toolbar-save").click(function(){b(".zlfield input").each(function(){b(this).val()||b(this).remove()});return!0});b(document).ready(function(){b(".zlfield-main .chzn-container").each(function(){b(this).prev("select").data("chosen",null).show();b(this).remove()});b(".col-left ul.element-list").on("element.added",
function(c,h){a.actions(b(h))});b("ul.ui-sortable").on("sortstop",function(c,h){var f=RegExp(/(elements\[[a-z0-9_-]+\])|(positions\[[a-z0-9_-]+\]\[[0-9]+\])/);b("#assign-elements ul.element-list:not(.unassigned)").each(function(){var a="positions["+b(this).data("position")+"]";b(this).children().each(function(c){b(this).find("[data-control^=positions], [data-control^=elements]").each(function(){b(this).attr("data-control","tmp"+b(this).attr("data-control").replace(f,a+"["+c+"]"))})})});f=RegExp(/^tmp/);
b("#assign-elements ul.element-list").find("[data-control^=tmp]").each(function(){b(this).attr("data-control",b(this).attr("data-control").replace(f,""))});a.actions(h.item)});a.initActions()})},initActions:function(){var g=this,f=g.options.enviroment;"type-positions"!=f&&"type-edit"!=f||b(".col-left ul.ui-sortable > li.element").each(function(){b(this).parent().trigger("sortstop",{item:b(this)})});"type-edit"==f&&b(".col-left .core-element-configuration .element-list > li.element").each(function(){g.actions(b(this))});
"item-edit"==f&&b(".item-edit .creation-form .zlfield-main").each(function(){g.actions(b(this))});"module"==f&&b("form#module-form .zlfield-main").each(function(){b(this).closest("li, .control-group").addClass("zlfield-module");b(this).closest(".controls").removeClass("controls");g.actions(b(this))});"app-config"==f&&b(".col-right .zlfield-main").each(function(){g.actions(b(this))})},actions:function(g){var f=this;g.data("zlfield-actions-init")||(g.find(".qTipHelp").each(function(){var a=b(this);
a.qtip({overwrite:!1,content:{text:a.find(".qtip-content")},position:{my:"bottom center",at:"top center",viewport:b(window)},show:{solo:!0,delay:300},hide:{fixed:!0,delay:300},style:"ui-tooltip-light ui-tooltip-zlparam"})}),g.find(".zl-select-expand").each(function(){var a=b(this);a.click(function(){b(this).prev().height(150);b(this).remove()}).qtip({overwrite:!1,content:{text:a.data("zl-qtip")},position:{at:"right top",my:"left bottom"},show:{solo:!0,delay:600},hide:{delay:0},style:"ui-tooltip-light ui-tooltip-zlparam"})}),
b("#toolbar-apply, #toolbar-save").on("mousedown",function(){g.find(".zl-row[data-type=password] .zl-field input").each(function(){b(this).val("zl-decrypted["+b(this).val()+"]")})}),g.find(".zl-state").each(function(){var a=b(this).find("input"),c=a.closest(".zl-row");a.on("change",function(){"checked"==b(this).attr("checked")?(c.removeClass("zl-disabled"),c.find(".zl-field").children().removeAttr("disabled")):(c.addClass("zl-disabled"),c.find(".zl-field").children().attr("disabled",!0))}).trigger("change")}),
g.find(".zl-state input").each(function(){var a=b(this);a.qtip({content:{text:"Override this field"},position:{at:"left top",my:"right bottom",effect:!1},show:{target:a.closest(".zl-row"),solo:!0,delay:200},hide:{target:a.closest(".zl-row"),delay:0},style:"ui-tooltip-light ui-tooltip-zlparam",events:{show:function(b,h){"checked"==a.attr("checked")&&b.preventDefault();a.bind("change",function(){h.hide()});h.set("content.text",a.parent().attr("tooltip"))}}})}),g.find(".zl-toggle").each(function(){var a=
b(this),c=a.next();b(".btn-open",a).on("click",function(){a.toggleClass("open")&&c.show()});b(".btn-close",a).on("click",function(){a.toggleClass("open")&&c.hide()})}),g.find("[data-dependents]").each(function(){var a=b(this),c=a.data("dependents").replace(/ /g,"").split("|"),h=a.closest(".zlfield.placeholder .wrapper, .zlfield.placeholder").first();c.each(function(c){var f=c.split("!>"),k=2==f.length?"!>":">",f=">"==k?c.split(">"):f;d=f[0].split(",");e=f[1].replace("NONE","");"select"!=a.data("type")&&
"itemLayoutList"!=a.data("type")&&"layout"!=a.data("type")&&"apps"!=a.data("type")&&"types"!=a.data("type")&&"elements"!=a.data("type")&&"modulelist"!=a.data("type")&&"separatedby"!=a.data("type")||d.each(function(c){var f=h.find('[data-id="'+c+'"]').data("e",e).data("m",k).hide();a.find(".zl-field select").bind("change",function(){var a=f.data("e"),c=f.data("m"),h=b.makeArray(b(this).val()),k=0;if(a&&a.match(/OR/g))b.each(h,function(b,f){var h=RegExp("(\\b|OR)"+f+"(\\b|OR)","g");("!>"==c&&!a.match(h)||
">"==c&&a.match(h))&&(k=1)});else if(a&&a.match(/AND/g)){var p=a.split("AND").length;h.length==p&&b.each(h,function(b,f){var h=RegExp("(\\b|AND)"+f+"(\\b|AND)","g");k="!>"==c&&!a.match(h)||">"==c&&a.match(h)?1:0})}else b.each(h,function(b,f){("!>"==c&&f!=a||">"==c&&f==a)&&(k=1)});k&&f.slideDown("fast")||f.slideUp("fast")}).trigger("change")});"checkbox"==a.data("type")&&d.each(function(c){var f=h.find('[data-id="'+c+'"]').hide();a.find(".zl-field input").bind("change",function(){var a="checked"==
b(this).attr("checked");("!>"==k&&!a||">"==k&&a)&&f.slideDown("fast")||f.slideUp("fast")}).trigger("change")});"radio"==a.data("type")&&d.each(function(c){var f=e,p=h.find('[data-id="'+c+'"]').hide();a.find(".zl-field input").bind("change",function(){var a="checked"==b(this).attr("checked"),c=0,h=b(this).attr("value");a&&(f&&f.match(/OR/g)?(a=RegExp(h,"g"),("!>"==k&&!f.match(a)||">"==k&&f.match(a))&&(c=1)):("!>"==k&&h!=f&&a||">"==k&&h==f&&a&&a)&&(c=1),c&&p.slideDown("fast")||p.slideUp("fast"))}).trigger("change")});
"text"==a.data("type")&&d.each(function(f){var c=h.find('[data-id="'+f+'"]').hide();a.find(".zl-field input").on("keyup change",function(){var a=""!=b(this).val();("!>"==k&&!a||">"==k&&a)&&c.slideDown("fast")||c.slideUp("fast")}).trigger("change")})})}),g.find("[data-dependent]").each(function(){var a=b(this).hide(),c=a.data("dependent").replace(/ /g,""),h=c.match(/AND/g)?c.split("AND"):[],g=c.match(/OR/g)?c.split("OR"):[],p=a.parents(".zlfield.placeholder .wrapper, .zlfield.placeholder").first();
a.on("zlfield-dependent-event",function(b){A_match=0;(A_match=h.length?f.evaluateDependentRules(h,a,p,"AND"):f.evaluateDependentRules(g,a,p,"OR"))&&a.slideDown("fast")||a.slideUp("fast")}).trigger("zlfield-dependent-event")}),g.find("[data-relieson]").each(function(){var a=b(this),c=a.data("relieson"),h=a.parents(".placeholder").find('[data-id="'+c.id+'"]').find("select");h.on("change",function(){var g=b(this).val()?b(this).val():"",p=b(this).closest(".zl-field"),k=c.json,m=a.attr("data-control"),
n=b(this).closest(".zlfield-main").attr("data-ajaxargs"),l=c.psv,q=c.id;l[c.id]=g;p.append(b('<span class="activity zl-loader">'));b.ajax({type:"POST",url:c.url+"&task=loadfield",data:{json:k,ctrl:m,psv:l,pid:q,node:null,args:n,ajaxcall:!0,enviroment:f.options.enviroment,enviroment_args:f.options.enviroment_args}}).done(function(c){c=b.parseJSON(c);p.find(".activity").remove();a.slideUp("fast",function(){a.empty();c&&c.result&&a.html('<div class="loaded-fields">'+c.result+"</div>");f.actions(a.find("> .loaded-fields"));
a.slideDown("fast");h.trigger("loaded.zlfield")})})})}),g.find(".load-field-btn").on("click",function(a){a.preventDefault();a=b(this);var c=a.parent(".zlfield-main"),h=c.data("ajaxargs");a.find("span").addClass("zlux-loader-raw");b.ajax({url:f.options.url,type:"POST",data:{task:"loadZLfield",group:h.group,type:f.options.type,control_name:h.control_name,json_path:h.json_path,element_id:h.element_id,element_type:h.element_type,enviroment:h.enviroment,node:h.node},success:function(a){a=b.parseJSON(a);
c.fadeOut("fast",function(){b(this).html(a.result);f.actions(c);c.fadeIn("slow")})}})}),b("[data-type=items] .zl-field",g).each(function(){var a=b(this),c=b("input.zlux-x-dummy",a),f=c.val(),g=c.data("params");c.remove();a.zlux("FieldsLoader",b.extend({},g,{field:"items",controlName:f}))}),g.data("zlfield-actions-init",!0))},evaluateDependentRules:function(g,f,a,c){var h=0,l=1;g.each(function(g){if(!l)return!1;var k=g.split("!="),m=2==k.length?"!=":"==",k="=="==m?g.split("=="):k;field=a.find('[data-id="'+
k[0]+'"]');type=field.data("type");unique_id=c+"-"+f.data("id")+"-"+field.data("id")+"-"+a.data("id");e=k[1].replace("NONE","");if("select"==type||"itemLayoutList"==type||"layout"==type||"apps"==type||"types"==type||"elements"==type||"modulelist"==type||"separatedby"==type){g=field.find(".zl-field select");var k=b.makeArray(g.val()),n=0;if(e&&e.match(/OR/g))b.each(k,function(a,b){var c=RegExp("(\\b|OR)"+b+"(\\b|OR)","g");("!="==m&&!e.match(c)||"=="==m&&e.match(c))&&(n=1)});else if(e&&e.match(/AND/g)){var r=
e.split("AND").length;k.length==r&&b.each(k,function(a,b){var c=RegExp("(\\b|AND)"+b+"(\\b|AND)","g");n="!="==m&&!e.match(c)||"=="==m&&e.match(c)?1:0})}else b.each(k,function(a,b){("!="==m&&b!=e||"=="==m&&b==e)&&(n=1)});h=n;g.data("zlfield-dependent-"+unique_id+"-init")||(g.on("change",function(){f.trigger("zlfield-dependent-event")}),g.data("zlfield-dependent-"+unique_id+"-init",!0))}"checkbox"==type&&(g=field.find(".zl-field input"),n=0,k="checked"==g.attr("checked"),("!="==m&&!k||"=="==m&&k)&&
(n=1),h=n,g.data("zlfield-dependent-"+unique_id+"-init")||(g.on("change",function(){f.trigger("zlfield-dependent-event")}),g.data("zlfield-dependent-"+unique_id+"-init",!0)));if("radio"==type){g=field.find(".zl-field input");var n=0,q=e;g.each(function(){var a="checked"==b(this).attr("checked"),c=b(this).attr("value");a&&(q&&q.match(/OR/g)?(a=RegExp(c,"g"),("!="==m&&!q.match(a)||"=="==m&&q.match(a))&&(n=1)):("!="==m&&c!=q&&a||"=="==m&&c==q&&a&&a)&&(n=1))});h=n;g.data("zlfield-dependent-"+unique_id+
"-init")||(g.on("change",function(){f.trigger("zlfield-dependent-event")}),g.data("zlfield-dependent-"+unique_id+"-init",!0))}"text"==type&&(g=field.find(".zl-field input"),k=""!=g.val(),("!="==m&&!k||"=="==m&&k)&&(n=1),h=n,g.data("zlfield-dependent-"+unique_id+"-init")||(g.on("keyup change",function(){f.trigger("zlfield-dependent-event")}),g.data("zlfield-dependent-"+unique_id+"-init",!0)));if("AND"==c&&!h||"OR"==c&&h)l=!1});return h}});b.fn[l.prototype.name]=function(){var g=arguments,f=g[0]?g[0]:
null;return this.each(function(){var a=b(this);if(l.prototype[f]&&a.data(l.prototype.name)&&"initialize"!=f)a.data(l.prototype.name)[f].apply(a.data(l.prototype.name),Array.prototype.slice.call(g,1));else if(!f||b.isPlainObject(f)){var c=new l;l.prototype.initialize&&c.initialize.apply(c,b.merge([a],g));a.data(l.prototype.name,c)}else b.error("Method "+f+" does not exist on jQuery."+l.name)})}})(jQuery);